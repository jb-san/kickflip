# Integration Test Environment
#
# This creates an isolated Docker network to test the full kickflip flow:
#   Server <-> Client <-> Test Web App
#
# Usage:
#   cd tests/integration
#   docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
#
# The test-runner container will:
#   1. Wait for server to be healthy
#   2. Generate client keys
#   3. Register client with server
#   4. Start a test web server
#   5. Connect client to server
#   6. Verify the tunnel works
#   7. Exit with 0 on success, 1 on failure

services:
  # DNS resolver for *.test.local domain
  dns:
    image: coredns/coredns:latest
    container_name: kickflip-test-dns
    networks:
      testnet:
        ipv4_address: 172.28.0.2
    volumes:
      - ./coredns:/etc/coredns:ro
    command: -conf /etc/coredns/Corefile

  # Kickflip server
  server:
    build:
      context: ../..
      dockerfile: tests/integration/Dockerfile.test-server
    container_name: kickflip-test-server
    hostname: server.test.local
    networks:
      testnet:
        ipv4_address: 172.28.0.10
    dns: 172.28.0.2
    environment:
      KICKFLIP_SERVER_CONFIG: /etc/kickflip/kickflip-server.toml
      KICKFLIP_CLIENTS_DIR: /etc/kickflip/clients.d
      # Skip nginx reload in tests (no systemd)
      KICKFLIP_SKIP_NGINX_RELOAD: "0"
    volumes:
      - ./config/kickflip-server.toml:/etc/kickflip/kickflip-server.toml:ro
      - shared-clients:/etc/kickflip/clients.d
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 5s
    depends_on:
      dns:
        condition: service_started

  # Test runner - orchestrates the integration test
  test-runner:
    build:
      context: ../..
      dockerfile: tests/integration/Dockerfile.test-runner
    container_name: kickflip-test-runner
    hostname: client.test.local
    networks:
      testnet:
        ipv4_address: 172.28.0.20
    dns: 172.28.0.2
    environment:
      SERVER_HOST: server.test.local
      SERVER_API: http://server.test.local:8080
      TEST_DOMAIN: test.local
    volumes:
      - shared-clients:/server-clients
      - ./test-runner.sh:/test-runner.sh:ro
    depends_on:
      server:
        condition: service_healthy
    command: ["/test-runner.sh"]

networks:
  testnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  shared-clients:

