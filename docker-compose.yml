# Kickflip Server - Docker Compose
#
# Quick usage:
#   1. curl -O https://raw.githubusercontent.com/jb-san/kickflip/main/docker-compose.yml
#   2. Create config directory: mkdir -p config/clients.d
#   3. Create config/kickflip-server.toml (see example at bottom of this file)
#   4. Run: docker compose up -d
#   5. Add clients: docker compose exec kickflip kickflip-server add-client --pubkey "ssh-ed25519 ..." --name "my-laptop"

services:
  kickflip:
    image: ghcr.io/jb-san/kickflip-server:latest
    # Or build from source:
    # build:
    #   context: .
    #   dockerfile: Dockerfile.server
    container_name: kickflip-server
    restart: unless-stopped

    # Expose ports for HTTP, HTTPS, SSH tunnels, and API
    ports:
      - "80:80"       # HTTP (nginx)
      - "443:443"     # HTTPS (nginx)
      - "2222:2222"   # SSH tunnels (container's sshd)
      - "8080:8080"   # API (daemon)

    environment:
      # Path to config file inside container
      KICKFLIP_SERVER_CONFIG: /etc/kickflip/kickflip-server.toml
      # Clients directory (for authorized_keys sync)
      KICKFLIP_CLIENTS_DIR: /etc/kickflip/clients.d

    volumes:
      # Configuration and client keys (REQUIRED)
      # Create this directory with:
      #   mkdir -p config/clients.d
      #   touch config/kickflip-server.toml
      - ./config:/etc/kickflip

      # SSL certificates (Let's Encrypt) - persisted
      - letsencrypt:/etc/letsencrypt

      # Nginx configuration (managed by kickflip daemon)
      - nginx-sites:/etc/nginx/sites-available
      - nginx-enabled:/etc/nginx/sites-enabled

      # ACME challenge webroot for Let's Encrypt
      - acme-webroot:/var/www/letsencrypt

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  letsencrypt:
    name: kickflip-letsencrypt
  nginx-sites:
    name: kickflip-nginx-sites
  nginx-enabled:
    name: kickflip-nginx-enabled
  acme-webroot:
    name: kickflip-acme-webroot
# =============================================================================
# Example config/kickflip-server.toml:
# =============================================================================
#
# # Your base domain - clients connect to <subdomain>.<rp_id>
# rp_id = "t.example.com"
#
# # Where to store allowed client public keys
# clients_dir = "/etc/kickflip/clients.d"
#
# # Unix socket for CLI communication
# socket = "/tmp/kickflip.sock"
#
# # Nginx configuration directories
# nginx_available = "/etc/nginx/sites-available"
# nginx_enabled = "/etc/nginx/sites-enabled"
#
# # Let's Encrypt / ACME settings
# acme_webroot = "/var/www/letsencrypt"
# acme_email = "admin@example.com"  # Required for cert notifications
# auto_cert = true                   # Auto-obtain certs on first connect
#
# # TLS settings
# tls_enable = true      # Enable HTTPS
# tls_cert = ""          # Leave empty for auto Let's Encrypt
# tls_key = ""           # Leave empty for auto Let's Encrypt
# http_redirect = true   # Redirect HTTP to HTTPS
# hsts_enable = false    # Enable HSTS header
# hsts_max_age = 31536000
#
# # SSH settings
# ssh_user = "kickflip"
# authorized_keys = "/home/kickflip/.ssh/authorized_keys"
